/*! wakanda-client.node.js - v0.2.0 - 2016-03-14 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("request")):"function"==typeof define&&define.amd?define(["request"],e):"object"==typeof exports?exports.WakandaClient=e(require("request")):t.WakandaClient=e(t.request)}(this,function(t){return function(t){function e(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return t[n].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e,r){t.exports=r(1)},function(t,e,r){"use strict";var n=r(2),i=r(25);n["default"].HttpClient=i["default"],t.exports=n["default"]},function(t,e,r){"use strict";var n=r(3),i=r(23),o=r(13),s=r(21),a=function(){function t(e){this._httpClient=new t.HttpClient({apiPrefix:(e||"")+"/rest"});var r=new i["default"]({wakJSC:this});this.directory={login:function(t,e,n){return r.login(t,e,n)},logout:function(){return r.logout()},currentUser:function(){return r.currentUser()},currentUserBelongsTo:function(t){return r.currentUserBelongsTo(t)}},this.helper={isEntity:function(t){return t instanceof o["default"]},isCollection:function(t){return t instanceof s["default"]}}}return t.prototype.getCatalog=function(t){var e=new n["default"]({wakJSC:this});return e.get(t)},t.prototype.version=function(){return"0.2.0"},t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=a},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(4),o=r(5),s=r(7),a=r(8),u=r(9),l=function(t){function e(e){t.call(this,e),this.service=new o["default"]({wakJSC:this.wakJSC})}return n(e,t),e.prototype.needDataClass=function(t){-1===this.seenDataClasses.indexOf(t)&&this.seenDataClasses.push(t)},e.prototype.get=function(t){var e=this;return this.seenDataClasses=[],this.service.get(t).then(function(t){for(var r=[],n=0,i=t;n<i.length;n++){for(var o=i[n],l=[],c=0,p=o.attributes;c<p.length;c++){var d=p[c];switch(d.kind){case"relatedEntity":l.push(new a.AttributeRelated({name:d.name,type:d.type,kind:d.kind})),e.needDataClass(d.type);break;case"storage":case"calculated":case"alias":var h=d.readOnly||"image"===d.type||"blob"===d.type;l.push(new a.Attribute({name:d.name,type:d.type,readOnly:h,kind:d.kind}));break;case"relatedEntities":var f=new a.AttributeCollection({name:d.name,type:d.type,kind:d.kind});l.push(f),e.needDataClass(f.entityType);break;default:throw new Error("[WakandaClient] Unhandled "+d.kind+" attribute type")}}for(var y={entity:[],collection:[],dataClass:[]},_=0,v=o.methods;_<v.length;_++){var m=v[_];switch(m.applyTo){case"entity":y.entity.push(m.name);break;case"entityCollection":y.collection.push(m.name);break;case"dataClass":y.dataClass.push(m.name);break;default:throw new Error("[WakandaClient] Unrecognized method type")}}var C=new a.DataClass({name:o.name,collectionName:o.collectionName,attributes:l,methods:y}),g=new u["default"]({wakJSC:e.wakJSC,dataClass:C,methods:y});g._decorateDataClass(),r.push(C)}for(var b=new s["default"]({dataClasses:r}),w=0,S=e.seenDataClasses;w<S.length;w++){var E=S[w];if(!b[E])throw new Error("Needed "+E+" dataClass is not present on catalog")}return b})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=l},function(t,e){"use strict";var r=function(){function t(t){var e=t.wakJSC;this.wakJSC=e}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(6),o=function(t){function e(){t.apply(this,arguments)}return n(e,t),e.prototype.get=function(t){var e="/";if(Array.isArray(t))e+=t.join();else{if("undefined"!=typeof t)throw new Error("Catalog.get: first parameter should be an array");e+="$all"}return this.httpClient.get({uri:"/$catalog"+e}).then(function(t){for(var e=[],r=JSON.parse(t.body),n=0,i=r.dataClasses;n<i.length;n++){var o=i[n],s=[];if(o.attributes)for(var a=0,u=o.attributes;a<u.length;a++){var l=u[a];s.push({name:l.name,kind:l.kind,type:l.type,readOnly:l.readOnly})}var c=[];if(o.methods)for(var p=0,d=o.methods;p<d.length;p++){var h=d[p];c.push({name:h.name,applyTo:h.applyTo})}e.push({name:o.name,collectionName:o.collectionName,attributes:s,methods:c})}return e})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=o},function(t,e){"use strict";var r=function(){function t(t){var e=t.wakJSC;this.wakJSC=e,this.httpClient=e._httpClient}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e){"use strict";var r=function(){function t(t){for(var e=t.dataClasses,r=0,n=e;r<n.length;r++){var i=n[r];this[i.name]=i}}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e){"use strict";var r=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},n=function(){function t(t){var e=t.name,r=t.collectionName,n=t.attributes,i=t.methods;this.name=e,this.collectionName=r,this.attributes=n,this.methods=i}return t}();e.DataClass=n;var i=function(){function t(t){var e=t.name,r=t.type,n=t.readOnly,i=t.kind;this.name=e,this.type=r,this.readOnly=n===!0,this.kind=i}return t}();e.Attribute=i;var o=function(t){function e(){t.apply(this,arguments)}return r(e,t),e}(i);e.AttributeRelated=o;var s=function(t){function e(e){var r=e.name,n=e.type,i=e.readOnly,o=e.kind;t.call(this,{name:r,type:n,readOnly:i,kind:o}),this.entityType=n.substring(0,n.length-10)}return r(e,t),e}(i);e.AttributeCollection=s},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(4),o=r(10),s=r(15),a=r(16),u=r(19),l=r(13),c=r(21),p=r(8),d=r(22),h=r(18),f=r(14),y=new Map,_=function(t){function e(e){var r=e.wakJSC,n=e.dataClass,i=e.methods;t.call(this,{wakJSC:r}),this.dataClass=n,this.methods=i,this.service=new s["default"]({wakJSC:this.wakJSC,dataClass:n}),y.set(n.name,this),this._dataClassBusinessMap=y}return n(e,t),e.prototype._decorateDataClass=function(){this.dataClass.find=this.find.bind(this),this.dataClass.query=this.query.bind(this),this.dataClass.create=this.create.bind(this),this._addUserDefinedMethods()},e.prototype._addUserDefinedMethods=function(){var t=this,e=this;this.methods.dataClass.forEach(function(r){t.dataClass[r]=function(){var t=Array.from(arguments);return e.callMethod(r,t)}})},e.prototype.callMethod=function(t,e){var r=this;return this.service.callMethod(t,e).then(function(t){return f.MethodAdapter.transform(t,r._dataClassBusinessMap)})},e.prototype.find=function(t,e){var r=this,n=e||{};if(void 0!==n.filter||void 0!==n.params||void 0!==n.pageSize||void 0!==n.start||void 0!==n.orderBy)throw new Error("Dataclass.find: options filter, params, pageSize, start and orderBy are not allowed");return this.service.find(t,n).then(function(t){return r._presentationEntityFromDbo({dbo:t})})},e.prototype.query=function(t){var e=this,r=t||{},n=r.select;if(r.method&&r.method.length>0)throw new Error("Dataclass.query: option method is not allowed");return r.pageSize||(r.pageSize=h["default"].DEFAULT_PAGE_SIZE),this.service.query(r).then(function(t){return e._presentationCollectionFromDbo({dbo:t,pageSize:r.pageSize,initialSelect:n})})},e.prototype.create=function(t){var e={};if(t)for(var r in t)t[r]instanceof l["default"]&&(e[r]=t[r],delete t[r]);var n=this._presentationEntityFromDbo({dbo:t||{}});for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},e.prototype._createEntity=function(t){var e=t.key,r=t.deferred,n=new l["default"]({key:e,deferred:r,dataClass:this.dataClass}),i=new o["default"]({wakJSC:this.wakJSC,dataClass:this.dataClass,entity:n,dataClassBusiness:this});return i._decorateEntity(),n},e.prototype._createCollection=function(t){var e=t.uri,r=t.deferred,n=t.pageSize,i=t.initialSelect,o=new c["default"]({deferred:r,dataClass:this.dataClass}),s=new a["default"]({wakJSC:this.wakJSC,dataClass:this.dataClass,dataClassBusiness:this,collection:o,collectionUri:e,pageSize:n,initialSelect:i});return s._decorateCollection(),o},e.prototype._createMedia=function(t){var e=t.uri,r=t.isImage,n=t.attributeName,i=t.entity,o=new d["default"]({uri:e}),s=new u["default"]({wakJSC:this.wakJSC,media:o,dataClassBusiness:this,isImage:r,attributeName:n,entity:i});return s._decorateMedia(),o},e.prototype._presentationEntityFromDbo=function(t){var e,r=t.dbo;if(r||(e=null),r.__deferred)e=this._createEntity({key:r.__deferred.__KEY,deferred:!0});else{e=this._createEntity({key:r.__KEY}),e._stamp=r.__STAMP;for(var n=0,i=this.dataClass.attributes;n<i.length;n++){var o=i[n],s=r[o.name];if(s)if(o instanceof p.AttributeRelated){var a=y.get(o.type);e[o.name]=a._presentationEntityFromDbo({dbo:s})}else if(o instanceof p.AttributeCollection){var a=y.get(o.entityType);e[o.name]=a._presentationCollectionFromDbo({dbo:s})}else if("image"===o.type||"blob"===o.type){var u;u=s&&s.__deferred&&s.__deferred.uri?s.__deferred.uri:null,e[o.name]=this._createMedia({uri:u,isImage:"image"===o.type,attributeName:o.name,entity:e})}else e[o.name]=s||null;else"image"===o.type||"blob"===o.type?e[o.name]=this._createMedia({uri:null,isImage:"image"===o.type,attributeName:o.name,entity:e}):e[o.name]=null}}return e},e.prototype._presentationCollectionFromDbo=function(t){var e,r=t.dbo,n=t.pageSize,i=t.initialSelect;if(r)if(r.__deferred)e=this._createCollection({deferred:!0,uri:r.__deferred.uri});else{e=this._createCollection({uri:r.__ENTITYSET,pageSize:n||r.__ENTITIES.length,initialSelect:i}),e._count=r.__COUNT,e._first=r.__FIRST,e._sent=r.__SENT,e._pageSize=n;for(var o=0,s=r.__ENTITIES;o<s.length;o++){var a=s[o];e.entities.push(this._presentationEntityFromDbo({dbo:a}))}}else e=null;return e},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=_},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(4),o=r(11),s=r(8),a=r(13),u=r(14),l=function(t){function e(e){var r=e.wakJSC,n=e.entity,i=e.dataClass,s=e.dataClassBusiness;t.call(this,{wakJSC:r}),this.entity=n,this.dataClass=i,this.dataClassBusiness=s,this.service=new o["default"]({wakJSC:r,entity:n,dataClass:i})}return n(e,t),e.prototype._decorateEntity=function(){this.entity.save=this.save.bind(this),this.entity["delete"]=this["delete"].bind(this),this.entity.fetch=this.fetch.bind(this),this._addUserDefinedMethods()},e.prototype._addUserDefinedMethods=function(){var t=this,e=this;this.dataClassBusiness.methods.entity.forEach(function(r){t.entity[r]=function(){var t=Array.from(arguments);return e.callMethod(r,t)}})},e.prototype.fetch=function(t){var e=this,r=t||{};if(void 0!==r.filter||void 0!==r.params||void 0!==r.pageSize||void 0!==r.start||void 0!==r.orderBy)throw new Error("Entity.fetch: options filter, params, pageSize, start and orderBy are not allowed");return this.dataClassBusiness.find(this.entity._key,t).then(function(t){return e._refreshEntity({fresherEntity:t}),e.entity})},e.prototype.callMethod=function(t,e){var r=this;if(!this.entity._key)throw new Error("Entity."+t+": can not be called on an unsaved entity");return this.service.callMethod(t,e).then(function(t){return u.MethodAdapter.transform(t,r.dataClassBusiness._dataClassBusinessMap)})},e.prototype["delete"]=function(){var t=this;if(!this.entity._key)throw new Error("Entity.delete: can not delete unsaved entity");return this.service["delete"]().then(function(){t.entity=null})},e.prototype.save=function(){var t=this,e={};this.entity._key&&this.entity._stamp&&(e.__KEY=this.entity._key,e.__STAMP=this.entity._stamp);for(var r=0,n=this.dataClass.attributes;r<n.length;r++){var i=n[r],o=this.entity[i.name]||null;i instanceof s.AttributeRelated?e[i.name]=o?o._key:null:i instanceof s.AttributeCollection||i.readOnly||(e[i.name]=o)}var a=this._getExpandString();return this.service.save(e,a).then(function(e){var r=t.dataClassBusiness._presentationEntityFromDbo({dbo:e});return t._refreshEntity({fresherEntity:r}),t.entity})},e.prototype._refreshEntity=function(t){var e=t.fresherEntity;for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(this.entity[r]=e[r])},e.prototype._getExpandString=function(){for(var t="",e=0,r=this.dataClass.attributes;e<r.length;e++){var n=r[e];(n instanceof s.AttributeRelated||n instanceof s.AttributeCollection)&&this.entity[n.name]instanceof a["default"]&&(t+=n.name+",")}return t.length>0?t.slice(0,-1):null},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=l},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(6),o=r(12),s=function(t){function e(e){var r=e.wakJSC,n=e.entity,i=e.dataClass;t.call(this,{wakJSC:r}),this.entity=n,this.dataClass=i}return n(e,t),e.prototype.save=function(t,e){var r="";return e&&(r="&$expand="+e),this.httpClient.post({uri:"/"+this.dataClass.name+"?$method=update"+r,data:t}).then(function(t){var e=JSON.parse(t.body);return delete e.__entityModel,o["default"].removeRestInfoFromEntity(e),e})},e.prototype.callMethod=function(t,e){return this.httpClient.post({uri:"/"+this.dataClass.name+"("+this.entity._key+")/"+t,data:e}).then(function(t){var e=JSON.parse(t.body);return e.result||e||null})},e.prototype["delete"]=function(){return this.httpClient.get({uri:"/"+this.dataClass.name+"("+this.entity._key+")?$method=delete"}).then(function(t){var e=JSON.parse(t.body);return e&&e.ok===!0?!0:Promise.reject(new Error)})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=s},function(t,e){"use strict";var r=function(){function t(){}return t.handleOptions=function(t){if(!t)return"";var e=t.select,r=t.filter,n=t.params,i=t.pageSize,o=t.start,s=t.orderBy,a=t.method,u=t.emMethod,l="?";if(e&&(l+="&$expand="+e),r&&(l+='&$filter="'+r+'"'),s&&(l+="&$orderby="+s),n){if(!Array.isArray(n))throw new Error("params option must be an array");if(n.length>0){for(var c="[",p=0,d=n;p<d.length;p++){var h=d[p];c+="string"==typeof h?'"'+h+'",':h+","}c=c.slice(0,-1),c+="]",l+="&$params='"+c+"'"}}if(i){if(!this.isInteger(i))throw new Error("pageSize option must be an integer");l+="&$limit="+i}if(o){if(!this.isInteger(o))throw new Error("start option must be an integer");l+="&$skip="+o}return a&&(l+="&$method="+a),u&&(l+="&$emMethod="+u),l.length>1&&"&"===l[1]&&(l=l.replace("?&","?")),"?"===l?"":l},t.isInteger=function(t){return"number"==typeof t&&!isNaN(t)&&t%1===0},t.removeRestInfoFromEntity=function(t){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)){var r=t[e];r&&r.__deferred&&r.__deferred.__KEY&&delete r.__deferred.uri}},t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e){"use strict";var r=function(){function t(t){var e=t.key,r=t.deferred,n=t.dataClass;this._key=e,this._deferred=r===!0,Object.defineProperty(this,"_dataClass",{enumerable:!1,configurable:!1,writable:!1,value:n})}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e){"use strict";var r=function(){function t(){}return t.transform=function(t,e){if(t&&t.__entityModel){var r=e.get(t.__entityModel);if(r){if("undefined"!=typeof t.__COUNT&&"undefined"!=typeof t.__ENTITIES&&"undefined"!=typeof t.__FIRST&&"undefined"!=typeof t.__SENT)return r._presentationCollectionFromDbo({dbo:t});if(t.__KEY&&t.__STAMP)return r._presentationEntityFromDbo({dbo:t})}}return t},t}();e.MethodAdapter=r},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(6),o=r(12),s=function(t){function e(e){var r=e.wakJSC,n=e.dataClass;t.call(this,{wakJSC:r}),this.dataClass=n}return n(e,t),e.prototype.find=function(t,e){if("string"!=typeof t&&"number"!=typeof t)throw new Error("DataClass.find: Invalid id type");var r=o["default"].handleOptions(e);return this.httpClient.get({uri:"/"+this.dataClass.name+"("+t+")"+r}).then(function(t){var e=JSON.parse(t.body);return delete e.__entityModel,o["default"].removeRestInfoFromEntity(e),e})},e.prototype.query=function(t){t.method="entityset";var e=o["default"].handleOptions(t);return this.httpClient.get({uri:"/"+this.dataClass.name+e}).then(function(t){var e=JSON.parse(t.body);delete e.__entityModel;for(var r=0,n=e.__ENTITIES;r<n.length;r++){var i=n[r];o["default"].removeRestInfoFromEntity(i)}return e})},e.prototype.callMethod=function(t,e){return this.httpClient.post({uri:"/"+this.dataClass.name+"/"+t,data:e}).then(function(t){var e=JSON.parse(t.body);return e.result||e||null})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=s},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(4),o=r(17),s=r(18),a=r(14),u=function(t){function e(e){var r=e.wakJSC,n=e.dataClass,i=e.collection,s=e.dataClassBusiness,a=e.collectionUri,u=e.pageSize,l=e.initialSelect;t.call(this,{wakJSC:r}),this.collection=i,this.dataClass=n,this.dataClassBusiness=s,this.service=new o["default"]({wakJSC:r,collection:i,dataClass:n,collectionUri:a}),this.pageSize=u,this.initialSelect=l}return n(e,t),e.prototype._decorateCollection=function(){this.collection.fetch=this.fetch.bind(this),this.collection.nextPage=this.nextPage.bind(this),this.collection.prevPage=this.prevPage.bind(this),this.collection.more=this.more.bind(this),this._addUserDefinedMethods()},e.prototype.fetch=function(t){var e=this,r=t||{};if(r.method&&r.method.length>0)throw new Error("Collection.fetch: option method is not allowed");return r.pageSize||(r.pageSize=this.pageSize?this.pageSize:s["default"].DEFAULT_PAGE_SIZE),r.select&&(this.initialSelect=r.select),this.pageSize=r.pageSize,this.service.fetch(r).then(function(t){var r=e.dataClassBusiness._presentationCollectionFromDbo({dbo:t,pageSize:e.pageSize});return e._refreshCollection({fresherCollection:r}),e.collection})},e.prototype.more=function(){var t=this;if(this.collection._deferred===!0)throw new Error("Collection.more: can not call more on a deferred collection");var e={start:this.collection._first+this.collection._sent,pageSize:this.pageSize};return this.initialSelect&&(e.select=this.initialSelect),this.service.fetch(e).then(function(e){t.collection._sent+=e.__ENTITIES.length;for(var r=0,n=e.__ENTITIES;r<n.length;r++){var i=n[r];t.collection.entities.push(t.dataClassBusiness._presentationEntityFromDbo({dbo:i}))}return t.collection})},e.prototype.nextPage=function(){if(this.collection._deferred===!0)throw new Error("Collection.nextPage: can not call nextPage on a deferred collection");var t={start:this.collection._first+this.pageSize,pageSize:this.pageSize};return this.initialSelect&&(t.select=this.initialSelect),this.fetch(t)},e.prototype.prevPage=function(){if(this.collection._deferred===!0)throw new Error("Collection.prevPage: can not call prevPage on a deferred collection");var t={start:this.collection._first-this.pageSize,pageSize:this.pageSize};return this.initialSelect&&(t.select=this.initialSelect),this.fetch(t)},e.prototype._addUserDefinedMethods=function(){var t=this,e=this;this.dataClassBusiness.methods.collection.forEach(function(r){t.collection[r]=function(){var t=Array.from(arguments);return e.callMethod(r,t)}})},e.prototype.callMethod=function(t,e){var r=this;if(this.collection._deferred)throw new Error("Collection."+t+": can not be called on a deferred collection");return this.service.callMethod(t,e).then(function(t){return a.MethodAdapter.transform(t,r.dataClassBusiness._dataClassBusinessMap)})},e.prototype._refreshCollection=function(t){var e=t.fresherCollection;for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&"function"!=typeof e[r]&&(this.collection[r]=e[r])},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=u},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(6),o=r(12),s=function(t){function e(e){var r=e.wakJSC,n=e.collection,i=e.dataClass,o=e.collectionUri;t.call(this,{wakJSC:r}),this.collection=n,this.dataClass=i,this.collectionUri=o,this.isEntitySet=this._isEntitySetUri({uri:o})}return n(e,t),e.prototype.fetch=function(t){var e=this;if(!this.isEntitySet&&t.select&&t.select.length>0)throw new Error("Collection.fetch: option select is not allowed when collection is deferred");t.method="subentityset";var r=o["default"].handleOptions(t);this.isEntitySet||(r="&"+r.slice(1));var n=this._removeRestFromUri(this.collectionUri);return this.httpClient.get({uri:n+r}).then(function(t){var r=JSON.parse(t.body);r.__ENTITYSET&&(e.collectionUri=r.__ENTITYSET,e.isEntitySet=e._isEntitySetUri({uri:r.__ENTITYSET})),delete r.__entityModel;for(var n=0,i=r.__ENTITIES;n<i.length;n++){var s=i[n];o["default"].removeRestInfoFromEntity(s)}return r})},e.prototype.callMethod=function(t,e){var r=this._removeRestFromUri(this.collectionUri);if(this.isEntitySet)r+="/"+t;else{var n=o["default"].handleOptions({method:"subentityset",emMethod:t});r+="&"+n.slice(1)}return this.httpClient.post({uri:r,data:e}).then(function(t){var e=JSON.parse(t.body);return e.result||e||null})},e.prototype._removeRestFromUri=function(t){return t.slice(5)},e.prototype._isEntitySetUri=function(t){var e=t.uri;return/^\/rest\/\w+\/\$entityset\/[A-Z0-9]+(\?.*)?$/i.test(e)},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=s},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e["default"]={DEFAULT_PAGE_SIZE:40,DEFAULT_SESSION_DURATION:3600}},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(4),o=r(20),s=function(t){function e(e){var r=e.wakJSC,n=e.media,i=e.dataClassBusiness,s=e.isImage,a=e.attributeName,u=e.entity;t.call(this,{wakJSC:r}),this.media=n,this.entity=u,this.dataClassBusiness=i,this.isImage=s===!0,this.service=new o["default"]({wakJSC:r,mediaBusiness:this,media:n,attributeName:a,dataClassBusiness:i})}return n(e,t),e.prototype._decorateMedia=function(){this.media.upload=this.upload.bind(this),this.media["delete"]=this["delete"].bind(this)},e.prototype.upload=function(t,e){var r=this;if(!this.entity._key)throw new Error("Media.upload: entity must be saved before uploading a media");return this.service.upload(t,e).then(function(t){return t}).then(function(){return r.entity.fetch()})},e.prototype["delete"]=function(){var t=this;if(!this.entity._key)throw new Error("Media.upload: entity must be saved before deleting a media");return this.service["delete"]().then(function(){return t.entity.fetch()})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=s},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(6),o=function(t){function e(e){var r=e.wakJSC,n=e.mediaBusiness,i=e.media,o=e.attributeName,s=e.dataClassBusiness;t.call(this,{wakJSC:r}),this.dataClassName=s.dataClass.name,this.entity=n.entity,this.isImage=n.isImage,this.media=i,this.attributeName=o}return n(e,t),e.prototype.upload=function(t,e){var r=this._buildUri();return this.isImage&&(r+="?$rawPict="+e),this.httpClient.post({uri:r,data:t,binary:!0})},e.prototype["delete"]=function(){var t="/"+this.dataClassName+"("+this.entity._key+")",e={__KEY:this.entity._key,__STAMP:this.entity._stamp};return e[this.attributeName]=null,this.httpClient.post({uri:t,data:e})},e.prototype._buildUri=function(){return"/"+this.dataClassName+"("+this.entity._key+")/"+this.attributeName},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=o},function(t,e){"use strict";var r=function(){function t(t){var e=t.deferred,r=t.dataClass;this.entities=[],this._deferred=e===!0,Object.defineProperty(this,"_dataClass",{enumerable:!1,configurable:!1,writable:!1,value:r})}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e){"use strict";var r=function(){function t(t){var e=t.uri;this.uri=e}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(4),o=r(24),s=r(18),a=function(t){function e(e){var r=e.wakJSC;t.call(this,{wakJSC:r}),this.service=new o["default"]({wakJSC:r})}return n(e,t),e.prototype.login=function(t,e,r){var n=r||s["default"].DEFAULT_SESSION_DURATION;if("number"!=typeof n||0>=n)throw new Error("Directory.login: invalid duration parameter");return this.service.login(t,e,n)["catch"](function(){return Promise.reject(new Error("Directory.login: Unauthorized"))})},e.prototype.logout=function(){return this.service.logout()["catch"](function(){return Promise.reject(new Error("Directory.logout: logout failed"))})},e.prototype.currentUser=function(){return this.service.currentUser().then(function(t){return t})["catch"](function(){return Promise.reject(new Error("Directory.currentUser: user is not logged in"))})},e.prototype.currentUserBelongsTo=function(t){if("string"!=typeof t)throw new Error("Directory.currentUserBelongsTo: group must be a string");return this.service.currentUserBelongsTo(t).then(function(){return!0})["catch"](function(){return!1})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=a},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(6),o=function(t){function e(){t.apply(this,arguments)}return n(e,t),e.prototype.login=function(t,e,r){return this.httpClient.post({uri:"/$directory/login",data:[t,e,r]}).then(function(){return!0})},e.prototype.logout=function(){return this.httpClient.get({uri:"/$directory/logout"}).then(function(t){var e=JSON.parse(t.body);return e.result&&e.result===!0?!0:Promise.reject(new Error)})},e.prototype.currentUser=function(){return this.httpClient.get({uri:"/$directory/currentUser"}).then(function(t){var e=JSON.parse(t.body);return e.result&&e.result.ID?e.result:Promise.reject(new Error)})},e.prototype.currentUserBelongsTo=function(t){return this.httpClient.post({uri:"/$directory/currentUserBelongsTo",data:[t]}).then(function(t){var e=JSON.parse(t.body);return e&&e.result&&e.result===!0?!0:Promise.reject(new Error)})},e}(i["default"]);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=o},function(t,e,r){"use strict";var n=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},i=r(26),o=r(27),s=r(28),a=function(t){function e(e){var r=e.apiPrefix;t.call(this,{apiPrefix:r}),this.request=i,this.cookieJar=this.request.jar()}return n(e,t),e.prototype._clearCookie=function(){this.cookieJar=this.request.jar()},e.prototype.get=function(e){var r=e.uri,n=e.params;try{var i=t.prototype.get.call(this,{uri:r,params:n});if(null!==i)return Promise.resolve(i)}catch(o){return Promise.reject(o)}var s=this._getWithoutInterceptor({uri:r,params:n});return t.prototype.responseGet.call(this,r,s)},e.prototype._getWithoutInterceptor=function(t){var e=t.uri,r=t.params,n={url:this.prefix+e,method:"GET",qs:r,jar:this.cookieJar};return this._httpResponseAdaptor({requestOptions:n})},e.prototype.post=function(e){var r=e.uri,n=e.data,i=e.binary;try{var o=t.prototype.post.call(this,{uri:r,data:n,binary:i});if(null!==o)return Promise.resolve(o)}catch(s){return Promise.reject(s)}var a={url:this.prefix+r,method:"POST",form:n,jar:this.cookieJar};try{i||(a.headers={"Content-Type":"application/json"},a.form=JSON.stringify(n))}catch(s){return Promise.reject(s)}var u=this._httpResponseAdaptor({requestOptions:a});return t.prototype.responsePost.call(this,r,u)},e.prototype._httpResponseAdaptor=function(t){var e=this,r=t.requestOptions;return new Promise(function(t,n){e.request(r,function(e,r,i){e||r.statusCode>=400?n(e||{statusMessage:r.statusMessage,body:i}):t(new s["default"]({statusCode:r.statusCode,headers:[],body:i}))})})},e}(o.HttpClient);Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=a},function(t,e){t.exports=require("request")},function(t,e){"use strict";var r=function(){function t(t){var e=t.apiPrefix;this.prefix=e,this._getRequestInterceptors=[],this._postRequestInterceptors=[],this._getResponseInterceptors=[],this._postResponseInterceptors=[]}return t.prototype.get=function(t){for(var e=0;e<this._getRequestInterceptors.length;e++){var r=this._getRequestInterceptors[e],n=r(t);if(null!==n&&"undefined"!=typeof n)return n}return null},t.prototype.post=function(t){for(var e=0;e<this._postRequestInterceptors.length;e++){var r=this._postRequestInterceptors[e],n=r(t);if(null!==n&&"undefined"!=typeof n)return n}return null},t.prototype.responseGet=function(t,e){for(var r=0,n=this._getResponseInterceptors;r<n.length;r++){var i=n[r],o=i(t,e);if(o)return o}return e},t.prototype.responsePost=function(t,e){for(var r=0,n=this._postResponseInterceptors;r<n.length;r++){var i=n[r],o=i(t,e);if(o)return o}return e},t.prototype.registerRequestInterceptor=function(t,e){var r=this,n=this._interceptorTypeToArray(t);n.forEach(function(t){"get"===t?r._getRequestInterceptors.push(e):"post"===t&&r._postRequestInterceptors.push(e)})},t.prototype.registerResponseInterceptor=function(t,e){var r=this,n=this._interceptorTypeToArray(t);n.forEach(function(t){"get"===t?r._getResponseInterceptors.push(e):"post"===t&&r._postResponseInterceptors.push(e)})},t.prototype._interceptorTypeToArray=function(t){var e=this,r=[];if("string"==typeof t){if(!this._isValidInterceptorType(t.toLowerCase()))throw new Error("HttpClient.registerInterceptor: invalid interceptor type");r.push(t.toLowerCase())}else{if(!Array.isArray(t))throw new Error("HttpClient.registerInterceptor: type must be a string or an array");t.forEach(function(t){if(!e._isValidInterceptorType(t.toLowerCase()))throw new Error("HttpClient.registerInterceptor: invalid interceptor type");r.push(t.toLowerCase())})}return r},t.prototype._isValidInterceptorType=function(t){var e=["get","post"];return-1!==e.indexOf(t)},t}();e.HttpClient=r,Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r},function(t,e){"use strict";var r=function(){function t(t){var e=t.statusCode,r=t.headers,n=t.body;this.statusCode=e,this.headers=r||[],this.body=n}return t}();Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=r}])});
//# sourceMappingURL=wakanda-client.node.min.js.map